Linuxサーバ監視設定
===================

Linux サーバのCacti, Zabbix監視設定をします。
コミュニティ版Getperfを用いた標準的な設定手順となり、以下の順に設定を行います。

* Linuxサーバにエージェント監視設定
* Cactiグラフ設定
* Zabbixホスト登録

監視仕様は以下の通りです。

+------------------------+----------------------------------------------------------------------------------------+
| Key                    | Description                                                                            |
+========================+========================================================================================+
| **パフォーマンス統計** | **Cactiサーバリソースグラフ**                                                          |
+------------------------+----------------------------------------------------------------------------------------+
| vmstat                 | **CPU** CPU Util% / CPU RunQue **メモリ** Free Memory / Swap rate                      |
+------------------------+----------------------------------------------------------------------------------------+
| loadavg                | **ロードアベレージ**  CPU Load Average                                                 |
+------------------------+----------------------------------------------------------------------------------------+
| memfree                | **メモリ**  Memory Usage / Memory Usage Detail                                         |
+------------------------+----------------------------------------------------------------------------------------+
| iostat                 | **ディスクI/O統計**  ディスクビジー率 / ディスクIOPS / ディスク転送量 / ディスクIO遅延 |
+------------------------+----------------------------------------------------------------------------------------+
| netDev                 | **ネットワークI/O統計** ネットワークパケット数 / ネットワーク転送量 / 通信エラー       |
+------------------------+----------------------------------------------------------------------------------------+
| diskutil               | **ディスク容量** ディスク使用率                                                        |
+------------------------+----------------------------------------------------------------------------------------+
| **イベント**           | **Zabbix 監視**                                                                        |
+------------------------+----------------------------------------------------------------------------------------+
| Linux                  | Zabbix 標準テンプレートのLinuxテンプレートによる監視                                   |
+------------------------+----------------------------------------------------------------------------------------+

Linux サーバ構成確認
--------------------

監視対象の Linux サーバについて以下の情報を事前に確認します。

* サーバIPアドレス
* rootパスワード
   運用上、rootパスワードの開示が不可の場合は、後述のroot作業手順をユーザに連絡し、ユーザに対応してもらう様、依頼します。
* 監視用ユーザの作成有無
   指定がない場合は、ユーザ名 zabbix でユーザを作成します。
* Linux OS バージョン
   RedHat系 5.x / 6.x 、その他ディストリビューションのOS名、バージョンを確認します。
* Linux アーキテクチャ
   32bit(i686), 64 bit(x86_64)を確認します。
* 監視サーバのIPアドレス、サイトキー、アクセスキー

   .. note:: 監視サーバのサイトキー、アクセスキーはサイトホームディレクトリの 'site_info.txt' に記載されています。

エージェントのセットアップ
--------------------------

監視対象の Linux サーバに ssh 接続して以下の作業を行います。

/var/log/messagesのアクセス権付与
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

syslogはroot権限のみ読み取りが可能であるため、そのままではZABBIXで監視を行なうことができません。
このため、監視用ユーザでもアクセス出来る様にsyslogファイルに読み取り権限を付与します。

監視サーバに root ユーザで ssh 接続します。
root の使用許可がない場合は、以下の設定をユーザに依頼します。

::

   ssh -l root {監視対象Linux}

監視用ユーザでもアクセス出来る様に読み取り権限を付与します。

::

   chmod a+rx /var/log/
   chmod 644 /var/log/messages

logrotateにパーミッション変更の処理を追記します。

::

   vi /etc/logrotate.d/syslog

postrotate の前にに以下の行を追加します。

::

   create 0644 root root
   postrotate

監視用ユーザの作成
^^^^^^^^^^^^^^^^^^

続いて root にて監視用ユーザを作成します。
ユーザで既に作成済みで、監視用ユーザの指定がある場合は不要です。
ユーザ名などの指定がない場合は既定の、zabbix ユーザを作成します。

::

   useradd zabbix

パスワードを設定します。

::

   passwd zabbix

エージェントモジュールの配布
^^^^^^^^^^^^^^^^^^^^^^^^^^^^

以降の作業は作成した監視用ユーザで行います。
root で接続済みの場合は su で監視用ユーザにスイッチしてください。

::

   su - zabbix

監視サーバからエージェントモジュールアーカイブをホームディレクトリ下にダウンロードします。
ダウンロードサイトから該当するOS、アーキテクチャのモジュールをダウンロードします。
以下は、Oracle Linuxサーバ、64bit 版のダウンロード例となります。

::

   scp psadmin@{監視サーバ}:~/getperf/var/agent/getperf-zabbix-Build6-OracleServer6-x86_64.tar.gz .

各OS/アーキテクチャと、該当するアーカイブファイルは以下の通りです。

+---------------------+---------------------------------------------+
| OS / アーキテクチャ | モジュール                                  |
+=====================+=============================================+
| RHEL5系 / 32 bit    | getperf-zabbix-Build6-CentOS5-i386.tar.gz   |
+---------------------+---------------------------------------------+
| RHEL5系 / 64 bit    | getperf-zabbix-Build6-CentOS5-x86_64.tar.gz |
+---------------------+---------------------------------------------+
| RHEL6系 / 32 bit    | getperf-zabbix-Build6-CentOS6-i386.tar.gz   |
+---------------------+---------------------------------------------+
| RHEL6系 / 64 bit    | getperf-zabbix-Build6-CentOS6-x86_64.tar.gz |
+---------------------+---------------------------------------------+

アーカイブを解凍します。

::

   tar xvf getperf-zabbix-Build6-OracleServer6-x86_64.tar.gz

解凍すると、ホームディレクトリ下に ptune というディレクトリが作成されます。
本ディレクトリ下で、収集デーモンの起動、採取データの蓄積、転送を行います。

Getperfエージェントのセットアップ
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

エージェントのセットアップコマンドを実行し、サーバの登録をします。
ptune/bin ディレクトリに移動します。

::

   cd ptune/bin

エージェントセットアップコマンドを実行します。

::

   ./getperfctl setup --url=https://{監視サーバ}:57443/

URLの箇所は各サイトのサイト管理用URLを指定してください。
コマンド実行後、各サイトのサイトキーアクセスキーを入力してください。

実行例は以下の通りです。

.. code-block:: bash

   ./getperfctl setup
   /home/psadmin/ptune/network/License.txt : No such file or directory
   SSLライセンスファイルの初期化をします
   サイトキーを入力して下さい :xxx
   アクセスキーを入力して下さい :xxx
   ホストの登録情報がありませんでした。登録を開始します
   以下のホスト情報を 'https://xxx.xxx.xxx.xxx:57443/axis2/services/GetperfService' に送信し、ホストを登録します
   SITEKEY : xxx
   HOST    : paas
   OSNAME  : CentOS

   ホストを登録します。よろしいですか(y/n) ?:y
   /home/psadmin/ptune 下の構成ファイルを /home/psadmin/ptune/_bk にバックアップしました
   構成ファイル [network] を更新しました

.. note:: 既に登録済みのサーバを再登録する場合、一旦、ptune/network/Lincese.txt ファイルを削除してから実行してください。

startコマンドでエージェントを起動します。

::

   ./getperfctl start

"ps -ef | grep _getperf" コマンドで、_getperf プロセスがある事を確認します。

.. note:: プロセスが起動されていない場合は、~/ptune/_log/getperf.log からエラーの内容を確認してください。

Zabbixエージェントのセットアップ
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

監視用ユーザで ~/ptune/script/zabbix/update_config.sh を実行します。
以下スクリプトでZabbixエージェントの設定ファイル ~/ptune/zabbix_agentd.conf を作成します。

::

   ~/ptune/script/zabbix/update_config.sh

エージェントを起動します。

::

   ~/ptune/bin/zabbixagent start

"ps -ef | grep zabbix" コマンドで、zabbix プロセスがある事を確認します。

.. note:: プロセスが起動されていない場合は、/tmp/zabbix_agentd.log からエラーの内容を確認してください。

サービス起動設定
^^^^^^^^^^^^^^^^

以下の作業は root で実行します。root の使用許可がない場合は、ユーザに以下作業を依頼してください。

::

   su -
   perl (監視用ユーザホーム)/ptune/bin/install.pl --all

実行例は以下の通りです。

::

   Startup script : /etc/init.d/getperfagent,/etc/init.d/zabbixagent
   Agent home     : /home/psadmin/ptune
   Owner          : psadmin
   OK ?(y/n) [n] y

以上で、エージェントの設定作業は終了です。extiコマンドでログアウトしてください。

採取データの集計確認
--------------------

以降の作業は監視サーバ側で行います。
監視サーバに psadmin ユーザでssh接続し、サイトホームディレクトリに移動します。

::

   ssh -l psadmin {監視サーバ}
   cd /home/psadmin/{サイトキー}

以下コマンドで登録したサーバ転送データが保存されていることを確認します。

::

   find analysis/Linux/{サーバ名}

また、以下コマンドで登録したサーバのノード定義情報を確認します。

::

   find node/Linux/{サーバ名}

.. note::

   * エージェントを起動して5分後に監視サーバに採取データが転送され、データ集計を開始します。エージェント起動直後にノード定義ファイルが存在しない場合はしばらく待ってから確認してください。
   * ノード定義ファイルが存在しない場合は、"sumup status"コマンドでデータ集計デーモンが起動されているか確認してください。また、/usr/local/tomcat-data/logs の下のTomcat Webサービスログにエラーがないか確認してください。

ノード定義ファイルにノードパス node_path パラメータがあるか確認してください。
値が、"{システム名}/{サーバ名}" となっていることを確認します。

::

   grep node_path node/Linux/{サーバ名}/info/os.json
   node/Linux/{サーバ名}/info/os.json:   "node_path" : "/tantai/{サーバ名}"

ない場合は、Cacti 、Zabbix 登録時に手動で node_path を指定します。
また、ある場合も手動で指定をすると、指定した値が有効になります。
以降の手順では手動での指定手順を記します。
自動で node_path の登録が必要な場合は、後のセクションのマスター定義スクリプトの編集をし、新サーバのマスター登録をします。

Cactiグラフ設定
---------------

以下コマンドで、Cactiサイトのグラフ登録をします。

::

   cacti-cli node/Linux/{監視サーバ}/ --node-dir {ノードディレクトリ}

ノードディレクトリには、ディレクトリ形式でシステム名、用途などを指定してください。例：'/ASystem/DB'
WebブラウザからCactiサイトに接続して、グラフが登録されていることを確認します。
メニュー _default -> HW -> {システム名} の下に、各HWリソースのグラフが配置されていることを確認します。

.. note::

   cacti-cli コマンドは幾つかのオプションの指定があり、主なオプション指定方法を以下に記します。

   * グラフを上書き更新する場合

      ::

         cacti-cli node/Linux/{監視サーバ}/ -f # -fオプションを追加

   * ツリーメニューの更新をしない場合

      既に登録済みのグラフでグラフのツリーメニュー配置を変えたくない場合は-f --skip-treeオプションを追加します。

      ::

         cacti-cli node/Linux/{監視サーバ}/ -f --skip-tree

   * 複数サーバの登録でサーバ名でソートしたい場合

      指定したオプションでサーバ名をソートして順にグラフ登録をします。
      デフォルトは登録日付順(timestamp)となります。

      ::

         cacti-cli node/Linux/ --view-sort natural

   * 複数デバイスの登録で配置をソートしたい場合

      指定したオプションでデバイス名をソートして順にグラフ登録をします。デフォルトは登録順(none)となります。

      ::

         cacti-cli node/Linux/{監視サーバ}/device/iostat.json --device-sort natural

Zabbixホスト設定
----------------

zabbix-cli コマンドで、Zabbixサイトのホスト登録をします。

.. note:: 前セクションのCactiグラフ登録と同様に、サイトホームディレクトリ下で実行します。

初めに.hosts ファイルに登録するサーバのIPアドレスを登録します。
"{IPアドレス} {監視サーバ名}" の形式で登録します。

::

   echo "192.168.10.1 {監視サーバ}" >> .hosts

zabbix-cli --info コマンドで登録情報を確認します。

::

   zabbix-cli --info node/Linux/{監視サーバ}/ --node-dir {ノードディレクトリ}

"--node-dir tantai"と指定した場合の出力例を記します。

.. code-block:: perl

   host => {
     'interfaces' => [                         # インターフェース情報
       {
         'dns' => '',
         'useip' => 1,
         'ip' => '192.168.10.1',
         'type' => 1,
         'port' => '10050',
         'main' => 1
       }
     ],
     'ip' => '192.168.10.1',                   # ホスト情報
     'host_name' => '{監視サーバ}',
     'is_physical_device' => 1,
     'host_visible_name' => 'Linux - {監視サーバ}',
     'host_groups' => [                         # ホストグループ情報
       'Linux Servers',
       'Linux Servers tantai'
     ],
     'templates' => [                           # テンプレート情報
       'Template OS Linux',
       'Template OS Linux tantai'
     ]
   };

ホストグループは 'Linux Server' と末尾にシステム名が付いた2グループに所属させます。
ホストグループがない場合は新規にホストグループを作成します。
テンプレートは以下の2つのテンプレートを適用します。

* Linux標準テンプレートの 'Template OS Linux'
* 'Template OS Linux' の末尾にシステム名が付いたテンプレート。システム固有の監視設定は本テンプレートに設定します。

zabbix-cli --add コマンドでZabbixに登録します。

::

   zabbix-cli --add node/Linux/{監視サーバ}/ --node-dir {ノードディレクトリ}


WebブラウザからZabbixサイトに接続して、ホスト登録されていることを確認します。

Zabbix Linux テンプレートのカスタマイズ
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

.. note:: 既にZabbixのLinuxテンプレートをカスタマイズ済みの場合は以下作業は不要です。

Zabbix 標準の 'Template OS Linux' テンプレートには syslog 監視が有りません。
テンプレートに以下を設定をして syslog 監視を追加します。

**Syslog アイテム、トリガーの登録**

1. テンプレートメニューを選択して、リストから 'Template OS Linux' を選択します
2. Itemsを選択します
3. Create Item をクリックして以下のアイテムを登録します

   +-------------+------------------------------------------------+
   | Item        | Value                                          |
   +=============+================================================+
   | Name        | System log                                     |
   +-------------+------------------------------------------------+
   | Type        | Zabbix Agent(active)                           |
   +-------------+------------------------------------------------+
   | Key         | log[/var/log/messages, (error|critical|fatal)] |
   +-------------+------------------------------------------------+
   | Type        | log                                            |
   +-------------+------------------------------------------------+
   | Application | OS                                             |
   +-------------+------------------------------------------------+

4. Triggers メニューを選択して、Create Trigger をクリックして以下のトリガーを登録します

   +------------+----------------------------------------------------------------------------------------------------+
   | Item       | Value                                                                                              |
   +============+====================================================================================================+
   | Name       | SystemLog Error                                                                                    |
   +------------+----------------------------------------------------------------------------------------------------+
   | Expression | {Template OS Linux:log[/var/log/messages, (error|critical|fatal)].iregexp(error|critical|fatal)}=1 |
   +------------+----------------------------------------------------------------------------------------------------+
   | Severity   | Average                                                                                            |
   +------------+----------------------------------------------------------------------------------------------------+

マスター定義スクリプトの編集
----------------------------

.. note::

   監視対象サーバのノードディレクトリの識別を自動で行いたい場合は以下のマスター定義スクリプトを編集します。
   各Cacti, Zabbix 管理コマンドに --node-dir オプションを追加して、手動でノードディレクトリを追加する場合は、
   以下設定は不要です。

サイトディレクトリに移動し、マスター定義スクリプトを編集します。

::

   cd {サイトディレクトリ}
   vi lib/Getperf/Command/Master/SystemInfo.pm

本スクリプト内の get_system_by_node() 関数を編集します。
if文の文字列検索ででそのホスト名がどのシステムに属するかを記述しています。
文字列検索の条件を追加して、該当サーバ名の検索条件を追加してください。

.. code-block:: perl

   sub get_system_by_node {
      my ($host) = @_;
      $host = lc($host);
      my $system = 'UNKOWN';
      if ($host=~/^(yaqdb\d+|yaqts\d+)/) {
         <中略>
      }
   }

手動で受信データのデータ集計を実行し、マスター定義スクリプトを実行します。
サーバ名、日付、時刻ディレクトリの箇所は適宜修正してください。
ファイル名は、os_info.txt となります。

::

   sumup -l analysis/{監視サーバ}/SystemInfo/

以下コマンドで登録したサーバのノード定義情報を確認します。

::

   grep node_path node/Linux/{サーバ名}/info/os.json

設定を反映させるため、データ集計デーモンを再起動します。

::

   sumup restat
