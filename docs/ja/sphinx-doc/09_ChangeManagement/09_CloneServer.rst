仮想マシンの監視サーバ複製
==========================

仮想インフラ環境の仮想マシン上に構築した監視サーバをクローニングして新規
サーバに複製する手順を記します。

仮想マシンのクローニング
------------------------

ここでは、VMWare ESXi ホストに構築した仮想マシンの監視サーバを複製します。

ストレージの仮想マシンデータをコピー
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

VMWare vSphere クライアントにてデータストア下のファイルをコピーして仮想マシンを複製します。

* [仮想ホスト] – [構成タブ] – [ストレージ] の順に選択します。
* 任意のデータストアを選択し、「データストアの参照」をクリック。
* 「/」を選択した状態でフォルダ作成ボタンをクリックして、コピー先となる
  フォルダを任意の名前(半角英数字)で作成します。
* コピーしたい仮想マシンのフォルダを選択し、フォルダ内のデータを全て選択し、
  先ほど作成したフォルダを選択して、「貼り付け」をクリックします。

データコピーが完了するまでしばらく待ちます。
データコピーの時間は仮想マシンのデータ容量や環境に依存します。

仮想マシンをインベントリに登録
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

* コピーした仮想マシンの「XXX.vmx」ファイルを右クリックして、「インベントリへの追加」をクリックします。
* 仮想マシンの表示名に任意の名前を入力し、「次へ」をクリックします。
* 任意のリソースプールを選択し「次へ」をクリックします。
* サマリ画面を確認し、問題なければ「終了」をクリック。
* コピーした仮想マシンを起動します。
* 起動させると、以下のメッセージが出力されるので「コピーしました」を選択し、「OK」クリック。

コピーした仮想マシンを起動します。

コピーしたOSの環境設定
^^^^^^^^^^^^^^^^^^^^^^

複製した仮想マシンのコンソールで以下のネットワーク環境設定を行います。
udev のネットワークのルール設定ファイルを編集します。

::

   sudo vi /etc/udev/rules.d/70-persistent-net.rules

* 8 行目 : 以前のMACアドレスになります。これを一旦削除します。
* 11 行目 : 新しく自動生成したMACアドレスになります。
* udevでは、新しく検出したMACアドレスを eth0 とダブらない eth1 としています。
  これを eth1 → eth0 とします。

eth0 のネットワークのスクリプト設定ファイルを編集します。

::

   vi /etc/sysconfig/network-scripts/ifcfg-eth0

以下の箇所を編集します。

::

   # HWADDR=00:0C:29:87:3E:FD
   HWADDR=00:50:56:3E:19:99

* 4 行目 : 以前のMACアドレスになります。これを一旦削除します。
* 5 行目 : 新しく自動生成したMACアドレスを設定します。
* 先の 70-persistent-net.rules ファイルに設定してあった新しいMACアドレスになります。

システムを再起動します。

::

   sudo reboot

起動後、ifconfig コマンドで、eth0 が出力され、MACアドレスが正しいことを確認しておきましょう。

::

   ifconfig -a

`hostname` コマンドでホスト名を変更します。

::

   sudo hostname newserver1.somecompany.com

/etc/hosts ファイルを編集します。

::

   sudo vi /etc/hosts

複製したIPアドレスとホスト名を追加します。

::

   192.168.10.31   newserver1 newserver1.somecompany.com


/etc/sysconfig/network ファイルを編集します。

::

   sudo vi /etc/sysconfig/network

HOSTNAME の箇所を編集します。

::

   HOSTNAME=newserver1.somecompany.com

再度、システムを再起動します。

::

   sudo reboot


getperf 環境設定の変更
----------------------

getperf 管理ユーザ psadmin で getperf 環境の更新をします。
設定ファイルの自動生成スクリプト cre_config.pl を再実行します。

::

   cd $GETPERF_HOME
   perl script/cre_config.pl

SSHキーを再作成します。

::

   rex install_ssh_key

SSL中間認証局を再作成します。

.. note::

   SSLルート証明書はコピー元の証明書をそのまま使用し、
   SSL中間証明書、サーバ証明書を更新します。

::

   rex create_inter_ca  # 中間認証局作成

サーバ証明書を再作成します。

::

   rex server_cert

Apache設定ファイルの更新をします。

::

   sudo -E rex prepare_apache

再度、システムを再起動します。

getperfエージェントの再セットアップ
-----------------------------------

getperfエージェントはコピー元のホスト名で登録されているため、
一旦、エージェントを停止して再セットアップします。
一旦、エージェントを停止して、ライセンスファイルを削除します。

::

   cd ~/ptune/bin/
   ./getperfctl stop
   rm ../network/License.txt

getperfctlコマンドを使用して再セットアップをします。
--urlオプションで新しいIPアドレスを指定してください。

::

   ./getperfctl setup -u https://192.168.10.31:57443/

サイトキー、アクセスキーは従来と同じ値を指定して、セットアップをしてください。
エージェントを再起動します。

::

   ./getperfctl start

エージェント再起動後、サイトホーム下に新サーバのデータ集計が開始されます。
サイトホームディレクトリに移動して、新規にグラフを登録します。

::

   cd ~/work/site
   cacti-cli -f node/Linux/newserver1/

