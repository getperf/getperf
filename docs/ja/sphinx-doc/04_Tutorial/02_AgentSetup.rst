エージェント設定
================

Linux エージェント設定
----------------------

監視対象がLinuxの場合、セットアップは Linux のOS一般ユーザでインストールパッケージを解凍して行います。
インストールパッケージは前章で説明した `エージェントコンパイル <../03_Installation/10_AgentCompile.html>`_ で作成したパッケージで監視対象のOS　メジャーバージョン、アーキテクチャ(32bit,64bitなど)に合わせてパッケージをダウンロードします。ここでは、CentOS6 の 64bit 環境でのエージェントセットアップ手順を記します。

Getperf エージェントセットアップ
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

監視対象サーバに一般ユーザでログインします。集計サーバのダウンロードサイトから対象プラットフォームを選択してモジュールをダウンロードします。

::

    wget http://{監視サーバアドレス}/docs/download/getperf-zabbix-Build4-CentOS6-x86_64.tar.gz

パッケージを解凍します。

::

    tar xvf getperf-zabbix-Build4-CentOS6-x86_64.tar.gz

エージェント管理コマンドの getperfctl を使用して、監視サーバとの疎通確認をします。
監視サーバとの通信はクライアント認証型の HTTPS 通信をするため、そのセットアップとして、 クライアント証明書の発行、ダウンロードをします。 getperfctl　setup コマンドで実行します。

::

    ~/ptune/bin/getperfctl setup

実行後、コンソールメッセージが出力され、 'サイトキーを入力して下さい'、'アクセスキーを入力して下さい'　のメッセージは前節で作成したサイトのサイトキー、アクセスキーを入力してください。更新しますかの確認で y を入力して設定を完了します。

以下の通り実行オプションにサイトキーとアクセスコードを付けることも可能です。複数台のセットアップの場合は、本オプションを使用してください。

::

    ~/ptune/bin/getperfctl setup --key={サイトキー} --pass={アクセスキー}

'構成ファイル [network] を更新しました' と出力されたら、HTTPS の設定は完了です。以下コマンドでデーモンを起動してください。

::

    ~/ptune/bin/getperfctl start

サービス起動確認。該当プロセスが存在するか確認します。

::

    ps -ef | grep _getperf

Zabbix エージェントセットアップ
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Zabbix エージェント設定ファイル作成スクリプトを実行します。

::

    ~/ptune/script/zabbix/update_config.sh

本スクリプトは ptune ディレクトリの下に　zabbix_agentd.conf　ファイルを生成します。zabbix_agentd.conf　ファイルは最終行に、監視サーバのアドレスと自身のホスト名を登録します。

以下コマンドで Zabbix エージェントを起動します。

::

    ~/ptune/bin/zabbixagent start

サービス起動確認。該当プロセスが存在するか確認します。

::

    ps -ef | grep zabbix_agent

OS起動時の自動起動設定
~~~~~~~~~~~~~~~~~~~~~~

OS起動時の自動起動設定を行います。本手順は root　ユーザでの実行が必要となります。上記手順で Getperf エージェントと Zabbix　エージェントは起動済みのため、本手順は保留として、この後の設定を継続することも可能です。
root　での作業権限がない場合は以下の作業をシステムオーナに依頼してください。

::

    su - root
    perl (ptune ホームディレクトリ)/bin/install.pl --all

設定内容を確認して、y を入力してください。

.. note::

    Getperf エージェントのみを起動する場合は以下をしてください。

    ::

        perl (ptune ホームディレクトリ)/bin/install.pl --module=getperf

以上でエージェント設定は完了です。この後は集計サーバ側の設定を行います。

.. note::

    手動でのエージェントの起動、停止について

    以下のスクリプトで各エージェントの起動、停止が可能です。インストールで使用したOSユーザで実行してください。

    Getperf エージェントの起動/停止

    ::

        ~/ptune/bin/getperfctl stop     # 停止する場合
        ~/ptune/bin/getperfctl start    # 起動する場合

    Zabbix エージェントの起動/停止

    ::

        ~/ptune/bin/zabbixagent stop    # 停止する場合
        ~/ptune/bin/zabbixagent start   # 起動する場合

Windows エージェント設定
------------------------

Windows のエージェントインストールは administrator　ユーザで行います。
インストール先は任意ですが、ここでは C　ドライブの直下に c:というディレクトリを作成してインストールします。

.. note::

    コマンドプロンプトを用いてセットアップコマンドを実行しますが、サービスの登録で管理者権限が必要なため、 **管理者権限付きコマンドプロンプト** で実行してください。
    管理者権限付きコマンドプロンプトは、Windows　のスタートアップメニューからコマンドプロンプトを選択し、右クリックで管理者権限付きを選択して起動します。

.. note::

    Windows のパッケージは、Windows のバージョン、アーキテクチャ(32bit,64bit)の違いによりパッケージファイルが異なることはありません。
    共通で、Windows-MSWin32　というプラットフォーム名のパッケージを使用してください。

Getperf エージェントセットアップ
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

スタートアップメニューからコマンドプロンプトを選択し、右クリック管理者権限で起動します。

::

    cd /d c:\

Webブラウザから監視サーバのダウンロードサイト
http://{監視サーバアドレス}/docs/download/ を開き、以下パッケージを
c: の直下に保存します。

::

    getperf-zabbix-Build4-Windows-MSWin32.zip

エクスプローラを開き、 ダウンロードしたパッケージファイルを右クリックして解凍を選択し、解凍先を
c:\ にして解凍してください。

解凍すると、c:\\ptune の下に実行モジュール、各設定ファイルが配置されます。c:\\ptune\\bin に移動し、以下のセットアップコマンドを実行します。
監視サーバにクライアント証明書発行を依頼し、HTTPS の通信設定をします。

::

    cd \ptune\bin
    .\getperfctl.exe setup

サイトキー、アクセスキーを入力し、'更新しますか?' の確認で y を入力して設定を完了します。
以上で通信設定は終わりです。その後、サービス起動の設定をします。
getperfctl install コマンドで Windowsサービスへ Getperf エージェントの登録をします。

::

    .\getperfctl.exe install

Windows サービスから Getperf エージェントの起動をします。

::

    .\getperfctl.exe start

エージェントの起動確認をします。
c:の下に採取コマンドの実行結果が保存されるので起動した時刻のディレクトリが生成されているかを確認します。

Zabbix エージェントセットアップ
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

C:の下の Zabbix エージェント設定ファイル作成スクリプトを実行します。
ptuneの下に zabbix\_agentd.conf ファイルが生成されます。

::

    cd C:\ptune\script\zabbix
    update_config.bat

続けて以下のスクリプトでWindowsサービスの登録を行い、Zabbix エージェントを起動します。

::

    setup_agent.bat

Zabbix エージェントが起動されると、c: の直下に、 zabbix\_agent.log が生成されます。
メモ帳などでログを開いて、 'agent # started' というメッセージが出力されてることを確認して起動を確認します。
Windows の場合は、各エージェントのサービス起動設定を合わせて行うので、OS起動時の自動起動設定を別途行う必要はありません。

以上でエージェント設定は完了で、この後は集計サーバ側の設定を行います。

.. note::

    手動でのエージェントの起動、停止について

    以下のスクリプトで各エージェントの起動、停止が可能です。administrator ユーザで実行してください。

    Getperf エージェントの起動/停止

    ::

        C:\ptune\bin\getperfctl.exe stop    # 停止する場合
        C:\ptune\bin\getperfctl.exe start   # 起動する場合

    Zabbix エージェントの起動/停止

    ::

        C:\ptune\script\zabbix\agent_control.bat --stop     # 停止する場合
        C:\ptune\script\zabbix\agent_control.bat --start    # 起動する場合
