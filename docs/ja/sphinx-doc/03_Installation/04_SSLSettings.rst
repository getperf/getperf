SSL設定
=======

各種SSL証明書の作成を行います。証明書は /etc/getperf/ssl の下に作成されます。

SSHキーの作成
-------------

Git 通信用に管理者ユーザの $HOME/.ssh ディレクトリ下に SSH キーファイルを作成します。 
Git を用いて、外部の Getperf サイトを複製する場合は、作成した.ssh/id_rsa.pub ファイルを公開鍵ファイルとして使用します。詳細は、 `サイトの複製 <../10_Miscellaneous/05_SiteCloning.html>`_ を参照してください。

::

    cd $GETPERF_HOME
    rex install_ssh_key

SSL証明書の作成
---------------

エージェント Web サービスの HTTPS 通信用にプライベート認証局を作成します。/etc/getperf/ssl/ca の下に各証明書を保存します。

::

    rex create_ca        # ルート認証局作成
    rex create_inter_ca  # 中間認証局作成

.. note::

	Getperfはプラベートルート認証局と中間認証局の2段構成の認証局で構成します。監視サーバ1台でルート認証局を作成し、それ以外のサーバは作成したルート認証局をコピーしてルート認証局を共有することが可能です。複数監視サーバでの認証局構築手順については、 その他の `複数サーバでのSSLルート認証局共有 <../10_Miscellaneous/04_SSLCertificateInstration.html>`_　を参照してください。ここでは、1台にルート認証局と中間認証局の2つを作成する手順を記します。

サーバ証明書の作成
------------------

エージェント Web サービスの Apache サーバ用のSSL証明書を作成します。/etc/getperf/ssl/server の下に各証明書を保存します。後述の Apache HTTP サーバのインストールで本証明書を設定します。

::

    rex server_cert

クライアント証明書の自動更新スケジュール登録
--------------------------------------------

監視対象のクライアント証明書は、getperf_site.json 設定ファイルに指定した値 GETPERF_SSL_EXPIRATION_DAY(デフォルトは365日) を有効期限として設定します。以下のスケジュール登録で、
定期的にクライアント証明書の自動更新をします。本スクリプトは登録した監視対象のクライアント証明書の
有効期限が 1 週間前になった場合に証明書の有効期限の更新をします。

::

    sudo rex run_client_cert_update

.. note::

	監視対象のエージェントは有効期限が切れるタイミングで新規証明書をダウンロードして自動更新を行います。

